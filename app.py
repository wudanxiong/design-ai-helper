import streamlit as st
import pandas as pd
import numpy as np
from openai import OpenAI
from paddleocr import PaddleOCR
import pdfplumber
from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
import cv2
import io
import json
import re
from datetime import datetime

# ================= é…ç½®ä¸åˆå§‹åŒ– =================

# ğŸ”´ğŸ”´ğŸ”´ è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨çš„ DeepSeek API Key ğŸ”´ğŸ”´ğŸ”´
API_KEY = "sk-90ed7f3913324b6391f15805f0f963ea" 
# DeepSeek å®˜æ–¹ API åœ°å€
BASE_URL = "https://api.deepseek.com"

# è®¾ç½®é¡µé¢
st.set_page_config(page_title="è£…ä¿®è§„åˆ’äº‘åŠ©æ‰‹", layout="wide")

# åˆå§‹åŒ– PaddleOCR (äº‘ç«¯æ¨¡å¼ï¼šä½¿ç”¨ CPU)
@st.cache_resource
def load_ocr():
    # use_gpu=False æ˜¯äº‘ç«¯è¿è¡Œçš„å…³é”®ï¼Œå¦åˆ™ä¼šæŠ¥é”™
    return PaddleOCR(use_angle_cls=True, lang="ch", use_gpu=False, show_log=False)

# å°è¯•åŠ è½½ OCRï¼Œé˜²æ­¢éƒ¨ç½²åˆæœŸæŠ¥é”™å¡æ­»
try:
    ocr = load_ocr()
except Exception as e:
    st.warning("OCR å¼•æ“æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œå¯èƒ½è¾ƒæ…¢...")
    ocr = None

# ================= é¢„è®¾é•¿æ–‡æœ¬å†…å®¹ (å®Œæ•´ç‰ˆ) =================
TEXT_BLOCKS = {
    "flow_1": """æ¨èã€1å·æµç¨‹ã€‘ï¼ˆç¬¬ä¸€æ­¥:ä»æŠ–éŸ³ã€å°çº¢ä¹¦ã€åˆæ­¥ç­›é€‰æ„Ÿè§‰é è°±æœ‰ç»éªŒçš„è®¾è®¡å¸ˆ
ï¼ˆç‹¬ç«‹è®¾è®¡å¸ˆä¼˜ç‚¹ï¼šèƒ½æ‹¿åˆ°ä½ å…¨éƒ¨æˆ–å¤§éƒ¨åˆ†è®¾è®¡è´¹ï¼Œè£…ä¿®å…¬å¸çš„è®¾è®¡å¸ˆè¦å’Œå…¬å¸å¹³åˆ†ï¼Œä½†å½“åœ°çš„ç‹¬ç«‹è®¾è®¡å¸ˆå¾ˆå°‘ï¼Œä¸”å¾ˆè´µï¼Œå¦‚æœä¸æ˜¯åˆ«å¢…å¤§å¹³å±‚ï¼Œåšå¾ˆå¤æ‚çš„ç¡¬è£…ï¼Œå¯ä»¥è€ƒè™‘å¤–åœ°çš„è®¾è®¡å¸ˆï¼‰
æ³¨æ„1ï¼šä¸“ä¸šè®¾è®¡å¸ˆä¸€å®šæ˜¯å…ˆä»˜è´¹æ‰ä¼šç»™ä½ åšä»¥åŠç”¨å¿ƒå»åšæ–¹æ¡ˆã€‚
æ³¨æ„2ï¼šå¦‚æœå¯¹æ¥çš„æ˜¯é”€å”®ä¸éœ€è¦èŠå¤ªå¤šï¼Œè¦æ±‚ç›´æ¥å¯¹æ¥è®¾è®¡å¸ˆå°±è¡Œï¼Œå»è·Ÿå…·ä½“è®¾è®¡å¸ˆèŠã€‚
ç¬¬äºŒæ­¥:æŒ‘é€‰æ„Ÿè§‰é è°±çš„é—®äº”ä¸ªé—®é¢˜
è¿™äº”ä¸ªé—®é¢˜å¯ä»¥æ–‡å­—ä¿¡æ¯æ²Ÿé€šï¼Œæœ¬ç€å¯¹è‡ªå·±è´Ÿè´£çš„æ€åº¦è¯·åŠ¡å¿…äº†è§£æ¸…æ¥šè®¾è®¡å¸ˆå…¨éƒ¨ä¿¡æ¯ã€‚
â‘ æ˜¯æœ¬äººæ¥è®¾è®¡å—ï¼Ÿ
â‘¡èƒ½ç­¾è®¾è®¡åˆåŒå—ï¼Ÿ(ä¸èƒ½çš„è¿‡)
â‘¢è®¾è®¡è´¹å¤šå°‘ä¸€å¹³ï¼ŒæŒ‰ä»€ä¹ˆç®—(æŒ‰å¥—å†…æˆ–å»ºç­‘å¤–è½®å»“åˆç†)ï¼›åŒ…å«å¤šå°‘å›¾çº¸(å¹³é¢å¸ƒå±€ï¼Œæ•ˆæœå›¾æ¦‚å¿µæ–¹æ¡ˆï¼Œæ•ˆæœå›¾ï¼Œå…¨å¥—æ–½å·¥å›¾)ï¼›ç”¨ä»€ä¹ˆè½¯ä»¶åšçš„ ï¼ˆéƒ½å¯ä»¥ï¼Œä½†ç”¨é…·å®¶ä¹åšçš„ä¾¿å®œï¼‰
â‘£æ˜¯å¦ç§‘ç­å‡ºèº«ï¼Ÿå¹²äº†å‡ å¹´ï¼Ÿå­¦è¿‡ç¾æœ¯æ²¡ï¼Ÿ
â‘¤èƒ½å¦æŒ‰æ¨¡æ¿æŠ¥ä»·å‡ºæŠ¥ä»·å•(åˆ°æ—¶å€™ç»™ä»–æˆ‘çš„æŠ¥ä»·æ¨¡æ¿)

æ³¨æ„ï¼šå¯ä»¥å…ˆè¯´ï¼šæˆ‘å®¶é‡Œå¯¹è®¾è®¡æœ‰ä¸€å®šè¦æ±‚ï¼Œæƒ³æ‰¾ä¸ªä¸“ä¸šæœ‰ç»éªŒä¸”èƒ½å¤Ÿæ ¹æ®æˆ‘çš„é¢„ç®—å¸®æˆ‘åšä¸“ä¸šè§„åˆ’çš„è®¾è®¡å¸ˆï¼Œè€Œä¸”æƒ³å…ˆç­¾è®¾è®¡åˆåŒå…ˆåšè®¾è®¡æ–¹æ¡ˆå†è€ƒè™‘æ–½å·¥çš„äº‹ã€‚

ç¬¬ä¸‰æ­¥:å¦‚æœå›ç­”çš„éƒ½å¯ä»¥ï¼Œç”¨æˆ‘çš„è®¾è®¡ä¸“ä¸šåº¦æé—®è¡¨è¿›è¡Œæé—®(ä¸€å®šæ˜¯æ‰“ç”µè¯æé—®ï¼Œå¯ä»¥è¯´å¯ä»¥ç”µè¯æ²Ÿé€šä¸€ä¸‹å—ï¼Œæœ‰å‡ ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸€ä¸‹)ï¼Œå¯¹äºé—®é¢˜çš„å›ç­”ç‡å‡†ç¡®ç‡è‡³å°‘è¦åœ¨60%ä»¥ä¸Šï¼Œå¦åˆ™å°±ç­›æ‰ã€‚

ç¬¬å››æ­¥: æœ€åç­›é€‰2-3ä¸ªåˆæ ¼è€…è¦2~3å¥—å¹³é¢â•æ•ˆæœå›¾â•cadæ–½å·¥å›¾(å¿…é¡»æ˜¯å¯¹èµ·æ¥çš„ä¸€å¥—æˆ¿å­çš„æˆå¥—çš„å›¾çº¸)ï¼Œå‘æ¥æˆ‘çœ‹ã€‚
å‘çš„æ—¶å€™è¯·å…ˆå‘è®¾è®¡å¸ˆæƒ…å†µï¼Œç„¶åå†å‘è®¾è®¡å¸ˆä½œå“ã€‚

ç¬¬äº”æ­¥:æˆ‘çœ‹è¿‡æ–¹æ¡ˆokåï¼Œç­¾ç‹¬ç«‹è®¾è®¡åˆåŒï¼Œåšè£…ä¿®æ ‡å‡†ã€‚
æ ‡å‡†ä¸€ï¼šè®¾è®¡æ–½å·¥æ ‡å‡†(æ·±åº¦å¹³é¢å¸ƒå±€å›¾ã€æ•ˆæœå›¾æ¦‚å¿µæ–¹æ¡ˆï¼Œæ‰€æœ‰æœ‰è®¾è®¡çš„åŒºåŸŸçš„æ•ˆæœå›¾ã€å®Œæ•´æ–½å·¥å›¾)
æ ‡å‡†äºŒï¼šæŠ¥ä»·æ ‡å‡†ï¼Œå°±æ˜¯åŸºç¡€è£…ä¿®æŠ¥ä»·å•(å¯ç›´æ¥ç”¨æˆ‘çš„æŠ¥ä»·æ¨¡æ¿å‡º)

ç¬¬å…­æ­¥ï¼šæ‰¾å…¬å¸è¿›è¡Œåˆæ­¥ç­›é€‰ï¼Œé€šè¿‡6ä¸ªç‚¹ç­›é€‰3~5å®¶
â‘ æŸ¥èµ„è´¨ï¼ˆæŸ¥è¥ä¸šæ‰§ç…§ï¼Œæˆç«‹æ—¶é—´ï¼Œæœ‰æ²¡æœ‰çº çº·ï¼Œç”¨ä¼æŸ¥æŸ¥ï¼‰
â‘¡æŸ¥è§„æ¨¡ï¼ˆå°å…¬å¸/è®¾è®¡å·¥ä½œå®¤è§„æ¨¡ä¸€èˆ¬åœ¨10äººä¸€ä¸‹ï¼Œ50äººä»¥ä¸Šå¯ç®—ä½œå¤§å…¬å¸ï¼Œä¸­é—´çš„æ˜¯å°å…¬å¸ï¼‰
â‘¢æ–½å·¥æ‰¿åŒ…æ–¹å¼ï¼ˆä¼˜å…ˆé€‰æ‹©èƒ½ç›´æ¥å®‰æ’å¸¸å¹´åˆä½œå·¥äººæ–½å·¥çš„ï¼‰
æ³¨ï¼šåˆ°æ—¶å€™å¯ä»¥å†è¯¦ç»†é—®æˆ‘
â‘£é—®ä»˜æ¬¾æ–¹å¼ï¼ˆé€‰æ‹©å…ˆæ–½å·¥åä»˜æ¬¾æˆ–é¦–ä»˜ä¸è¶…è¿‡20%çš„ï¼‰
â‘¤é—®åˆåŒæ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼ˆæˆ–è€…ç›´æ¥ç”¨è‡ªå·±çš„ç­¾ï¼‰
â‘¥çœ‹å·¥åœ°(çœ‹æ°´ç”µé˜¶æ®µï¼Œæœ¨å·¥æœªå°å®ŒçŸ³è†æ¿é˜¶æ®µï¼Œå®Œå·¥é˜¶æ®µ)
æ³¨ï¼šçœ‹å·¥åœ°å¯ä»¥æ‹è§†é¢‘ç»™æˆ‘
ç¬¬ä¸ƒæ­¥:
æŠŠè®¾è®¡æ–¹æ¡ˆå’Œæ ‡å‡†æŠ¥ä»·å‘ç»™è£…ä¿®å…¬å¸ï¼Œè¿½æ±‚æ€§ä»·æ¯”å°±æ‰¾ä¸­å°å…¬å¸ç›´æ¥å¯¹æ¥è€æ¿(çœå»äº†ç»™å‘˜å·¥çš„ä¸šåŠ¡ææˆ)ï¼Œè®©ä»–ä»¬åœ¨å®Œå…¨ç»Ÿä¸€çš„æ ‡å‡†ä¸‹å»å¡«ä»·æ ¼ï¼Œè®©ä»–ç›´æ¥æŠ›å»ç»™è®¾è®¡å¸ˆææˆï¼Œç„¶åæ¥æ¨ªå‘å¯¹æ¯”å„å®¶ä»·æ ¼ã€‚""",

    "flow_2": """æ¨èã€2å·æµç¨‹ã€‘ï¼ˆç¬¬ä¸€æ­¥ï¼šæ‰¾å…¬å¸è¿›è¡Œåˆæ­¥ç­›é€‰ï¼Œé€šè¿‡6ä¸ªç‚¹ç­›é€‰3~5å®¶
å…ˆé—®ä¸‹èƒ½å¦ç­¾ç‹¬ç«‹çš„è®¾è®¡åˆåŒ
â‘ æŸ¥èµ„è´¨ï¼ˆæŸ¥è¥ä¸šæ‰§ç…§ï¼Œæˆç«‹æ—¶é—´ï¼Œæœ‰æ²¡æœ‰çº çº·ï¼Œç”¨ä¼æŸ¥æŸ¥ï¼‰
â‘¡çœ‹è§„æ¨¡ï¼ˆä¼˜å…ˆé€‰æ‹©å¹²äº†5å¹´ä»¥ä¸Šçš„ä¸­å°å…¬å¸ï¼‰
â‘¢æ–½å·¥æ‰¿åŒ…æ–¹å¼ï¼ˆä¼˜å…ˆé€‰æ‹©èƒ½ç›´æ¥å®‰æ’å¸¸å¹´åˆä½œå·¥äººæ–½å·¥çš„ï¼‰
æ³¨ï¼šåˆ°æ—¶å€™å¯ä»¥å†è¯¦ç»†é—®æˆ‘
â‘£é—®ä»˜æ¬¾æ–¹å¼ï¼ˆé€‰æ‹©å…ˆæ–½å·¥åä»˜æ¬¾æˆ–é¦–ä»˜ä¸è¶…è¿‡20%çš„ï¼‰
â‘¤é—®åˆåŒæ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼ˆæˆ–è€…ç›´æ¥ç”¨è‡ªå·±çš„ç­¾ï¼‰
â‘¥çœ‹å·¥åœ°(çœ‹æ°´ç”µé˜¶æ®µï¼Œæœ¨å·¥æœªå°å®ŒçŸ³è†æ¿é˜¶æ®µï¼Œå®Œå·¥é˜¶æ®µ)
æ³¨ï¼šçœ‹å·¥åœ°å¯ä»¥æ‹è§†é¢‘ç»™æˆ‘
ç¬¬äºŒæ­¥:è¦æ±‚è£…ä¿®å…¬å¸å®‰æ’æœ‰å……è¶³è®¾è®¡ç»éªŒã€æ‡‚ææ–™å·¥è‰ºçš„è®¾è®¡å¸ˆå¯¹æ¥é—®äº”ä¸ªé—®é¢˜
è¿™äº”ä¸ªé—®é¢˜å¯ä»¥æ–‡å­—ä¿¡æ¯æ²Ÿé€šï¼Œæœ¬ç€å¯¹è‡ªå·±è´Ÿè´£çš„æ€åº¦è¯·åŠ¡å¿…äº†è§£æ¸…æ¥šè®¾è®¡å¸ˆå…¨éƒ¨ä¿¡æ¯ã€‚
â‘ æ˜¯æœ¬äººæ¥è®¾è®¡å—ï¼Ÿè¿˜æ˜¯å¤–åŒ…
â‘¡è®¾è®¡è´¹å¤šå°‘ä¸€å¹³ï¼ŒæŒ‰ä»€ä¹ˆç®—(æŒ‰å¥—å†…æˆ–å»ºç­‘å¤–è½®å»“åˆç†)ï¼›åŒ…å«å¤šå°‘å›¾çº¸(å¹³é¢å¸ƒå±€ï¼Œæ•ˆæœå›¾æ¦‚å¿µæ–¹æ¡ˆï¼Œæ•ˆæœå›¾ï¼Œå…¨å¥—æ–½å·¥å›¾)ï¼›ç”¨ä»€ä¹ˆè½¯ä»¶åšçš„ ï¼ˆéƒ½å¯ä»¥ï¼Œä½†ç”¨é…·å®¶ä¹åšçš„ä¾¿å®œï¼‰
â‘¢æ˜¯å¦ç§‘ç­å‡ºèº«ï¼Ÿå¹²äº†å‡ å¹´ï¼Ÿå­¦è¿‡ç¾æœ¯æ²¡ï¼Ÿ
â‘£èƒ½å¦æŒ‰æ¨¡æ¿æŠ¥ä»·å‡ºæŠ¥ä»·å•(åˆ°æ—¶å€™ç»™ä»–æˆ‘çš„æŠ¥ä»·æ¨¡æ¿)
æ³¨æ„ï¼šå¯ä»¥å…ˆè¯´ï¼šæˆ‘å®¶é‡Œå¯¹è®¾è®¡æœ‰ä¸€å®šè¦æ±‚ï¼Œæƒ³æ‰¾ä¸ªä¸“ä¸šæœ‰ç»éªŒä¸”èƒ½å¤Ÿæ ¹æ®æˆ‘çš„é¢„ç®—å¸®æˆ‘åšä¸“ä¸šè§„åˆ’çš„è®¾è®¡å¸ˆï¼Œè€Œä¸”æƒ³å…ˆç­¾è®¾è®¡åˆåŒå…ˆåšè®¾è®¡æ–¹æ¡ˆå†è€ƒè™‘æ–½å·¥çš„äº‹ã€‚

ç¬¬ä¸‰æ­¥:å¦‚æœå›ç­”çš„éƒ½å¯ä»¥ï¼Œåˆ™ç”¨æˆ‘çš„è®¾è®¡ä¸“ä¸šåº¦æé—®è¡¨è¿›è¡Œæé—®(ä¸€å®šæ˜¯æ‰“ç”µè¯æé—®ï¼Œå¯ä»¥è¯´å¯ä»¥ç”µè¯æ²Ÿé€šä¸€ä¸‹å—ï¼Œæœ‰å‡ ä¸ªé—®é¢˜æƒ³è¯·æ•™ä¸€ä¸‹)ï¼Œå¯¹äºé—®é¢˜çš„å›ç­”ç‡å‡†ç¡®ç‡è‡³å°‘è¦åœ¨60%ä»¥ä¸Šï¼Œå¦åˆ™å°±ç­›æ‰ã€‚

ç¬¬å››æ­¥: æœ€åç­›é€‰2-3ä¸ªåˆæ ¼è€…è¦2~3å¥—å¹³é¢â•æ•ˆæœå›¾â•cadæ–½å·¥å›¾(å¿…é¡»æ˜¯å¯¹èµ·æ¥çš„ä¸€å¥—æˆ¿å­çš„æˆå¥—çš„å›¾çº¸)ï¼Œå‘æ¥æˆ‘çœ‹ã€‚
å‘çš„æ—¶å€™è¯·å…ˆå‘è®¾è®¡å¸ˆæƒ…å†µï¼Œç„¶åå†å‘è®¾è®¡å¸ˆä½œå“ã€‚

ç¬¬äº”æ­¥:æˆ‘çœ‹è¿‡æ–¹æ¡ˆokåï¼Œç­¾ç‹¬ç«‹è®¾è®¡åˆåŒï¼Œåšè£…ä¿®æ ‡å‡†ã€‚
æ ‡å‡†ä¸€ï¼šè®¾è®¡æ–½å·¥æ ‡å‡†(æ·±åº¦å¹³é¢å¸ƒå±€å›¾ã€æ•ˆæœå›¾æ¦‚å¿µæ–¹æ¡ˆï¼Œæ‰€æœ‰æœ‰è®¾è®¡çš„åŒºåŸŸçš„æ•ˆæœå›¾ã€å®Œæ•´æ–½å·¥å›¾)
æ ‡å‡†äºŒï¼šæŠ¥ä»·æ ‡å‡†ï¼Œå°±æ˜¯åŸºç¡€è£…ä¿®æŠ¥ä»·å•(å¯ç›´æ¥ç”¨æˆ‘çš„æŠ¥ä»·æ¨¡æ¿å‡º)

ç¬¬å…­æ­¥:
æŠŠè®¾è®¡æ–¹æ¡ˆå’Œæ ‡å‡†æŠ¥ä»·å‘ç»™è£…ä¿®å…¬å¸ï¼Œè¿½æ±‚æ€§ä»·æ¯”å°±æ‰¾ä¸­å°å…¬å¸ç›´æ¥å¯¹æ¥è€æ¿(çœå»äº†ç»™å‘˜å·¥çš„ä¸šåŠ¡ææˆ)ï¼Œè®©ä»–ä»¬åœ¨å®Œå…¨ç»Ÿä¸€çš„æ ‡å‡†ä¸‹å»å¡«ä»·æ ¼ï¼Œè®©ä»–ç›´æ¥æŠ›å»ç»™è®¾è®¡å¸ˆææˆï¼Œç„¶åæ¥æ¨ªå‘å¯¹æ¯”å„å®¶ä»·æ ¼ã€‚ï¼‰""",

    "flow_3": """æ¨èã€3å·æµç¨‹ã€‘ï¼ˆç¬¬ä¸€æ­¥ï¼šæ‰¾å…¬å¸è¿›è¡Œåˆæ­¥ç­›é€‰ï¼Œé€šè¿‡6ä¸ªç‚¹ç­›é€‰35å®¶
ç¬¬ä¸€æ­¥ï¼šæ‰¾å…¬å¸è¿›è¡Œåˆæ­¥ç­›é€‰ï¼Œé€šè¿‡6ä¸ªç‚¹ç­›é€‰35å®¶å¹¶å…ˆé—®ä¸‹èƒ½å¦ç­¾ç‹¬ç«‹çš„è®¾è®¡åˆåŒ
â‘ æŸ¥èµ„è´¨ï¼ˆæŸ¥è¥ä¸šæ‰§ç…§ï¼Œæˆç«‹æ—¶é—´ï¼Œæœ‰æ²¡æœ‰çº çº·ï¼Œç”¨ä¼æŸ¥æŸ¥ï¼‰
â‘¡çœ‹è§„æ¨¡ï¼ˆä¼˜å…ˆé€‰æ‹©å¹²äº†5å¹´ä»¥ä¸Šçš„ä¸­å°å…¬å¸ï¼‰
â‘¢æ–½å·¥æ‰¿åŒ…æ–¹å¼ï¼ˆä¼˜å…ˆé€‰æ‹©èƒ½ç›´æ¥å®‰æ’å¸¸å¹´åˆä½œå·¥äººæ–½å·¥çš„ï¼‰
æ³¨ï¼šåˆ°æ—¶å€™å¯ä»¥å†è¯¦ç»†é—®æˆ‘
â‘£é—®ä»˜æ¬¾æ–¹å¼ï¼ˆé€‰æ‹©å…ˆæ–½å·¥åä»˜æ¬¾æˆ–é¦–ä»˜ä¸è¶…è¿‡20%çš„ï¼‰
â‘¤é—®åˆåŒæ˜¯å¦å¯ä»¥ä¿®æ”¹ï¼ˆæˆ–è€…ç›´æ¥ç”¨è‡ªå·±çš„ç­¾ï¼‰
â‘¥çœ‹å·¥åœ°(çœ‹æ°´ç”µé˜¶æ®µï¼Œæœ¨å·¥æœªå°å®ŒçŸ³è†æ¿é˜¶æ®µï¼Œå®Œå·¥é˜¶æ®µ)
æ³¨ï¼šçœ‹å·¥åœ°å¯ä»¥æ‹è§†é¢‘ç»™æˆ‘ï¼Œç›´æ¥ç¡®å®šå¥½è£…ä¿®å…¬å¸
ç¬¬äºŒæ­¥:è¦æ±‚è£…ä¿®å…¬å¸å®‰æ’æœ‰è®¾è®¡ç»éªŒã€æ‡‚ææ–™å·¥è‰ºçš„è®¾è®¡å¸ˆå¯¹æ¥ã€‚
ç¬¬ä¸‰æ­¥: äº¤ä¸è¶…è¿‡1000çš„å®šé‡‘ï¼Œå‡ºå¹³é¢å›¾å’Œæ•ˆæœå›¾ã€‚ å¹¶è¦æ±‚ç”¨æˆ‘çš„æŠ¥ä»·æ¨¡æ¿å‡ºæŠ¥ä»·ã€‚
ç¬¬å››æ­¥:åšå®Œå¹³é¢ã€æ•ˆæœå›¾ã€æŠ¥ä»·ï¼Œæ¯åšå®Œä¸€ä¸ªå‘æˆ‘å®¡ä¸€ä¸‹ã€‚
ç¬¬äº”æ­¥ï¼šéƒ½ä¸ºé—®é¢˜äº†å†ç­¾æ–½å·¥åˆåŒã€‚""",

    "mat_3": """æ¨èã€3å·è¾…æè¡¨ã€‘ï¼š
(ç”µçº¿:æ­£æ³°/æ™®ç‘æ–¯æ›¼ä½çƒŸæ— å¤ç”µçº¿; ç½‘çº¿ï¼šå¤§å”ç”µä¿¡/æ³›è¾¾/é£åˆ©æµ¦ç­‰å…­ç±»ç½‘çº¿+å…‰çº¤; ç©ºæ°”å¼€å…³:æ–½è€å¾·; ç©¿çº¿ç®¡åº•ç›’ï¼šä¼Ÿæ˜Ÿ/æ—¥ä¸°/ä¸­è´¢(é‡å‹çº¿ç®¡)ï¼› æ°´ç®¡:ç®¡å¾„25å¾·å›½å¾®æ³•/é˜”ç››ï¼ˆé¡¶éƒ¨æ°´ç®¡ç”¨é‡‘å±å›ºå®šä»¶ï¼‰; çŸ³è†æ¿é¾™éª¨ï¼šå¯è€ç¦/åœ£æˆˆç­ï¼› ç™½ä¹³èƒ¶ï¼šå°è¥¿/ç™¾å¾—ï¼› æ¬§æ¾æ¿:è¿›å£çˆ±æ ¼F4; é˜²æ°´:é©¬è´; ç“·ç –èƒ¶ï¼šé©¬è´ï¼› æ°´æ³¥ç ‚æµ†ï¼šé©¬è´æˆå“é¢„æ‹Œç ‚æµ†ï¼› æ‹‰æ¯›ä¹³æ¶²ï¼šé©¬è´sp700ï¼›å¢™å›ºï¼šé©¬è´Gï¼› è…»å­ç²‰çŸ³è†ç²‰ï¼šç¾å·¢/åœ£æˆˆç­ï¼› ä¹³èƒ¶æ¼†:çº¯è¿›å£ä¹³èƒ¶æ¼†ï¼ˆç¾å›½å¤§å¸ˆè‡³è‡»/éƒ½èŠ³å¸ƒå…°å¥‡ï¼‰ï¼› è‡ªæµå¹³ï¼šé©¬è´ï¼› æ¤ç­‹èƒ¶ï¼šæ‚é©¬ï¼›ä¸‹æ°´ç®¡é˜»å°¼ç‰‡ï¼šå¤§èƒ½ï¼›""",
    
    "mat_2": """æ¨èã€2å·è¾…æè¡¨ã€‘ï¼š
(ç”µçº¿ï¼šå½“åœ°å¤§å‚çš„/ç‰¹å˜æ™®é€šBVçº¿ï¼› ç©ºæ°”å¼€å…³ï¼šæ­£æ³°ï¼› ç½‘çº¿ï¼šå¤§å”ç”µä¿¡/æ³›è¾¾/é£åˆ©æµ¦ç­‰å…­ç±»ç½‘çº¿ï¼›ç©¿çº¿ç®¡åº•ç›’ï¼šä¼Ÿæ˜Ÿ/æ—¥ä¸°/ä¸­è´¢ï¼› æ°´ç®¡ï¼šä¼Ÿæ˜Ÿ/æ—¥ä¸°ï¼ˆé¡¶éƒ¨æ°´ç®¡ç”¨é‡‘å±å›ºå®šä»¶ï¼‰ï¼› çŸ³è†æ¿é¾™éª¨ï¼šå¯è€ç¦/åœ£æˆˆç­ï¼› ç™½ä¹³èƒ¶ï¼šå°è¥¿/ç™¾å¾—ï¼› åŸºå±‚æ¬§æ¾æ¿ï¼š å·´è¥¿LP/è¿›å£çˆ±æ ¼f4ï¼› é˜²æ°´ï¼šä¼Ÿæ˜Ÿå’–ä¹/å¾·é«˜å¢™åˆšåœ°æŸ”ï¼› ç“·ç –èƒ¶ï¼šå¾·é«˜/é›¨è™¹ï¼› æ‹‰æ¯›ä¹³æ¶²ï¼šé©¬è´sp700ï¼› å¢™å›ºï¼šé©¬è´Gï¼› è…»å­ç²‰çŸ³è†ç²‰ï¼šç¾å·¢/åœ£æˆˆç­ï¼ˆå—æ–¹æœ‰å›å—å¤©çš„è€ƒè™‘ç”¨è€æ°´è…»å­ï¼‰ï¼› ä¹³èƒ¶æ¼†ï¼šå¤šä¹å£«ä¸“ä¸šç”Ÿæ€æ— æ·»åŠ é‡‘é’»å…¨æ•ˆ/è‡´æ‚¦æŠ—ç”²é†›å‡€å‘³äº”åˆä¸€/ç«‹é‚¦äº‘å‡€ç«¹ç‚­æŠ—ç”²é†›äº”åˆä¸€æˆ–åŒæ¡£æ¬¡çŸ¥åå“ç‰Œä¹³èƒ¶æ¼†ã€‚)""",

    "mat_1": """æ¨èã€1å·è¾…æè¡¨ã€‘ï¼š
(ç”µçº¿ï¼šå½“åœ°å¤§å‚çš„æˆ–è€…ç‰¹å˜æ™®é€šBVçº¿; ç©ºæ°”å¼€å…³ï¼šå¾·åŠ›è¥¿; ç½‘çº¿ï¼šå¤§å”ç”µä¿¡/æ³›è¾¾/é£åˆ©æµ¦è¶…äº”ç±»ç½‘çº¿; ç©¿çº¿ç®¡åº•ç›’ï¼šè”å¡‘/ä¿åˆ©/ä¼Ÿæ˜Ÿ; æ°´ç®¡ï¼šè”å¡‘/ä¿åˆ©/ä¼Ÿæ˜Ÿ; çŸ³è†æ¿ï¼šæ³°å±±æ™®é€šçº¸é¢çŸ³è†æ¿; é¾™éª¨ï¼šå›½æ ‡é¾™éª¨; åŸºå±‚æ¬§æ¾æ¿ï¼šåƒå¹´èˆŸ/ä¸‡å/é²ä¸½e0; é˜²æ°´ï¼šä¼Ÿæ˜Ÿå’–ä¹/å¾·é«˜å¢™åˆšåœ°æŸ”; ç“·ç –èƒ¶ï¼šå¾·é«˜/é›¨è™¹; å¢™å›ºï¼šç«‹é‚¦/å¤šä¹å£«å¢™å›º; è…»å­ç²‰çŸ³è†ç²‰ï¼šç«‹é‚¦/å¤šä¹å£«/ç¥¥å¾—å£«ï¼ˆå—æ–¹æœ‰å›å—å¤©çš„è€ƒè™‘ç”¨è€æ°´è…»å­ï¼‰; ä¹³èƒ¶æ¼†ï¼šå¤šä¹å£«ä¸“ä¸šç”Ÿæ€æ— æ·»åŠ é‡‘é’»å…¨æ•ˆ/è‡´æ‚¦æŠ—ç”²é†›å‡€å‘³äº”åˆä¸€/ç«‹é‚¦äº‘å‡€ç«¹ç‚­æŠ—ç”²é†›äº”åˆä¸€æˆ–åŒæ¡£æ¬¡çŸ¥åå“ç‰Œä¹³èƒ¶æ¼†ã€‚)"""
}

# ================= æ ¸å¿ƒåŠŸèƒ½å‡½æ•° =================

def extract_text_from_file(uploaded_file):
    """æ ¹æ®æ–‡ä»¶ç±»å‹æå–æ–‡æœ¬å†…å®¹"""
    if ocr is None:
        st.error("OCR å¼•æ“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒé…ç½®ã€‚")
        return ""

    text_content = ""
    file_type = uploaded_file.name.split('.')[-1].lower()
    
    try:
        if file_type in ['jpg', 'jpeg', 'png']:
            # å›¾ç‰‡ OCR
            bytes_data = uploaded_file.getvalue()
            result = ocr.ocr(bytes_data, cls=True)
            if result and result[0]:
                for line in result[0]:
                    text_content += line[1][0] + "\n"
                    
        elif file_type == 'pdf':
            # PDF å¤„ç†
            with pdfplumber.open(uploaded_file) as pdf:
                for page in pdf.pages:
                    page_text = page.extract_text()
                    if page_text and len(page_text) > 20:
                        text_content += page_text + "\n"
                    else:
                        # æ‰«æç‰ˆ PDF è½¬å›¾ç‰‡ OCR
                        im = page.to_image(resolution=200) # é™ä½åˆ†è¾¨ç‡ä»¥åŠ å¿«äº‘ç«¯é€Ÿåº¦
                        img_byte_arr = io.BytesIO()
                        im.original.save(img_byte_arr, format='PNG')
                        result = ocr.ocr(img_byte_arr.getvalue(), cls=True)
                        if result and result[0]:
                            for line in result[0]:
                                text_content += line[1][0] + "\n"

        elif file_type == 'docx':
            doc = Document(uploaded_file)
            for para in doc.paragraphs:
                text_content += para.text + "\n"
            for table in doc.tables:
                for row in table.rows:
                    for cell in row.cells:
                        text_content += cell.text + " "
                    text_content += "\n"

        elif file_type in ['txt']:
            text_content = uploaded_file.getvalue().decode("utf-8")
        
        elif file_type in ['doc', 'wps']:
            st.warning(f"æ£€æµ‹åˆ° {file_type} æ ¼å¼ã€‚äº‘ç«¯ç¯å¢ƒå¯èƒ½æ— æ³•å®Œç¾è§£ææ—§ç‰ˆäºŒè¿›åˆ¶æ ¼å¼ï¼Œå»ºè®®å¦å­˜ä¸º docxã€‚")
            try:
                text_content = uploaded_file.getvalue().decode("gbk", errors='ignore')
            except:
                text_content = uploaded_file.getvalue().decode("utf-8", errors='ignore')

    except Exception as e:
        st.error(f"æ–‡ä»¶è¯»å–é”™è¯¯: {str(e)}")
        
    return text_content

def analyze_data_with_llm(raw_text):
    """è°ƒç”¨ DeepSeek API åˆ†æéç»“æ„åŒ–æ–‡æœ¬"""
    
    if "sk-" not in API_KEY:
        st.error("è¯·å…ˆåœ¨ä»£ç ä¸­å¡«å…¥æ­£ç¡®çš„ DeepSeek API Keyï¼")
        return None

    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®æå–åŠ©æ‰‹ã€‚è¯·é˜…è¯»ä»¥ä¸‹è£…ä¿®è°ƒæŸ¥è¡¨çš„å†…å®¹ï¼Œæå–å…³é”®æ•°æ®å¹¶ä»¥JSONæ ¼å¼è¿”å›ã€‚
    å¦‚æœç”¨æˆ·æœªæåŠæŸé¡¹ï¼Œè¯·åœ¨JSONå€¼ä¸­è¿”å› nullã€‚ä¸è¦è‡†é€ æ•°æ®ã€‚
    
    éœ€è¦æå–çš„å­—æ®µï¼ˆå­—æ®µåå¿…é¡»ä¸¥æ ¼ä¸€è‡´ï¼‰ï¼š
    1. hard_budget (ç¡¬è£…é¢„ç®—ï¼Œæ•°å­—ï¼Œå•ä½å…ƒ)
    2. total_budget (æ•´ä½“å…¥ä½é¢„ç®—ï¼Œæ•°å­—ï¼Œå•ä½å…ƒ)
    3. area (å»ºç­‘é¢ç§¯ï¼Œæ•°å­—ï¼Œå•ä½å¹³æ–¹ç±³)
    4. score (ç”¨æˆ·å¯¹è£…ä¿®æ•ˆæœçš„è¯„åˆ†è¦æ±‚ï¼Œ1-10åˆ†ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®åˆ†æ•°ä½†æœ‰æè¿°ï¼Œ9-10ä¸ºé«˜è¦æ±‚/å®Œç¾ï¼Œ7-8ä¸ºä¸­é«˜ï¼Œ5-6ä¸ºæ™®é€š/åŠæ ¼ï¼Œ5ä»¥ä¸‹ä¸ºæ— æ‰€è°“)
    5. has_paid_design (æ˜¯å¦å·²ä»˜è´¹è®¾è®¡ï¼Œtrue/false)
    6. personality_trouble (æ˜¯å¦æ€•éº»çƒ¦ï¼Œé€‰é¡¹ï¼š"æ€•éº»çƒ¦" æˆ– "ä¸æ€•éº»çƒ¦")
    7. personality_cautious (æ˜¯å¦è°¨æ…ï¼Œé€‰é¡¹ï¼š"è°¨æ…" æˆ– "æ•¢æ”¾æ‰‹")
    8. personality_perfect (æ˜¯å¦è¿½æ±‚å®Œç¾/å¹³è¡¡/æ€§ä»·æ¯”ï¼Œé€‰é¡¹ï¼š"è¿½æ±‚å®Œç¾", "è¿½æ±‚å¹³è¡¡", "è¿½æ±‚æ€§ä»·æ¯”")
    9. weekly_free_time (æ¯å‘¨ç©ºé—²æ—¶é—´ï¼Œæ•°å­—ï¼Œå•ä½å¤©)
    10. house_is_old (æ˜¯å¦è€æˆ¿ï¼Œtrue/false)
    11. house_age (æˆ¿é¾„ï¼Œæ•°å­—ï¼Œå¹´)
    12. ventilation (é€šé£æ™¾æ™’æ¡ä»¶ï¼Œé€‰é¡¹ï¼š"å¥½", "æ™¾æ™’å¤§äº1å¹´", "æ™¾æ™’å°äº1å¹´", "å·®")
    13. willing_to_self_build (æ˜¯å¦æ„¿æ„è‡ªè£…ï¼Œtrue/false)
    14. budget_can_cover_design (æ˜¯å¦æ¥å—è®¾è®¡è´¹ï¼Œtrue/falseï¼Œé»˜è®¤ä¸ºtrueé™¤éæ˜ç¡®æ‹’ç»)

    åŸæ–‡å†…å®¹ï¼š
    {raw_text[:3500]} 
    """
    
    try:
        client = OpenAI(api_key=API_KEY, base_url=BASE_URL)
        response = client.chat.completions.create(
            model="deepseek-chat", # DeepSeek V3
            messages=[
                {"role": "system", "content": "You are a helpful assistant that outputs strictly JSON."},
                {"role": "user", "content": prompt},
            ],
            response_format={ "type": "json_object" } # å¼ºåˆ¶ JSON æ ¼å¼ï¼Œæ›´ç¨³å®š
        )
        
        json_str = response.choices[0].message.content
        data = json.loads(json_str)
        return data
    except Exception as e:
        st.error(f"AI åˆ†æå¤±è´¥ (APIè°ƒç”¨é”™è¯¯): {e}")
        return None

def logic_engine(data):
    """åŸºäºè§„åˆ™çš„ä¸“å®¶ç³»ç»Ÿé€»è¾‘ (ä¿æŒåŸç‰ˆé€»è¾‘ä¸å˜)"""
    result = {}
    
    # è¾…åŠ©å‡½æ•°ï¼šå¤„ç†ç¼ºå¤±æ•°æ®
    def get_val(key, default=None):
        val = data.get(key)
        if val is None:
            return None
        return val

    # æå–æ•°æ®
    hard_budget = get_val('hard_budget')
    total_budget = get_val('total_budget')
    area = get_val('area')
    score = get_val('score')
    has_paid_design = get_val('has_paid_design')
    
    # é€»è¾‘ä¸€ï¼šé¢„ç®—æ˜¯å¦åˆç†
    res_1 = "å®¢æˆ·æœªæä¾›æ•°æ®"
    if hard_budget and total_budget:
        ratio = hard_budget / total_budget
        if ratio >= 0.5:
            res_1 = "åˆç†"
        elif ratio < 0.5 and (0.5 - ratio) > 0.2: 
            if ratio < 0.3:
                 res_1 = "ä¸åˆç†ã€‚å»ºè®®ï¼šç¡¬è£…é¢„ç®—é€šå¸¸åº”å æ•´ä½“é¢„ç®—çš„45%-55%å·¦å³ã€‚"
            else:
                 res_1 = "åŸºæœ¬åˆç†ï¼ˆåä½ï¼‰"
        else:
             res_1 = "ä¸åˆç†ã€‚å»ºè®®ï¼šç¡¬è£…é¢„ç®—é€šå¸¸åº”å æ•´ä½“é¢„ç®—çš„45%-55%å·¦å³ã€‚"
    result['budget_analysis'] = res_1

    # é€»è¾‘äºŒï¼šè®¾è®¡è´¹é¢„ç®—å»ºè®®
    res_2 = "å®¢æˆ·æœªæä¾›æ•°æ®"
    design_unit_price = 0
    
    if has_paid_design:
        res_2 = "ï¼ˆç•™ç™½ï¼šå®¢æˆ·å·²åšä»˜è´¹è®¾è®¡ï¼‰"
    elif hard_budget and area and score:
        hard_unit_price = hard_budget / area
        design_fee_str = ""
        
        # åˆ¤å®šé¢„ç®—åŒºé—´
        if 1300 <= hard_unit_price: 
            if area > 80 and score >= 9:
                design_fee_str = f"{int(hard_budget*0.10)} ~ {int(hard_budget*0.12)} å…ƒ"
            elif area > 80 and 7 <= score <= 8:
                design_fee_str = f"{int(hard_budget*0.08)} ~ {int(hard_budget*0.10)} å…ƒ"
            else:
                 design_fee_str = "å»ºè®®é¢„ç•™ç¡¬è£…é¢„ç®—çš„8%-10%" 
        
        elif 900 <= hard_unit_price < 1300: 
            if score >= 9:
                 design_fee_str = f"{int(hard_budget*0.10)} ~ {int(hard_budget*0.11)} å…ƒ"
            elif 7 <= score <= 8:
                 design_fee_str = f"{int(hard_budget*0.08)} ~ {int(hard_budget*0.09)} å…ƒ"
            else:
                 design_fee_str = "å»ºè®®é¢„ç•™ç¡¬è£…é¢„ç®—çš„7%-8%"

        elif 500 <= hard_unit_price < 900: 
            if score >= 9:
                design_fee_str = f"{int(hard_budget*0.09)} ~ {int(hard_budget*0.10)} å…ƒ"
            elif 7 <= score <= 8:
                design_fee_str = f"{int(hard_budget*0.07)} ~ {int(hard_budget*0.08)} å…ƒ"
            elif 5 <= score <= 6:
                design_fee_str = f"{int(hard_budget*0.05)} ~ {int(hard_budget*0.07)} å…ƒ"
            else:
                 design_fee_str = "å»ºè®®é¢„ç•™ç¡¬è£…é¢„ç®—çš„5%å·¦å³"

        elif hard_unit_price < 500: 
            if 7 <= score <= 8:
                design_fee_str = f"{int(hard_budget*0.07)} ~ {int(hard_budget*0.08)} å…ƒ"
            elif 5 <= score <= 6:
                design_fee_str = f"{int(hard_budget*0.05)} ~ {int(hard_budget*0.07)} å…ƒ"
            elif score < 5:
                design_fee_str = f"{int(hard_budget*0.03)} ~ {int(hard_budget*0.04)} å…ƒ"
            else:
                 design_fee_str = "å»ºè®®é¢„ç•™ç¡¬è£…é¢„ç®—çš„3%-5%"
        
        if design_fee_str:
            res_2 = design_fee_str
            try:
                nums = re.findall(r'\d+', design_fee_str)
                if len(nums) >= 2:
                    avg_total = (float(nums[0]) + float(nums[1])) / 2
                    design_unit_price = avg_total / area
            except:
                pass
    
    result['design_fee'] = res_2

    # é€»è¾‘ä¸‰ï¼šè®¾è®¡å¸ˆæ¡£æ¬¡å»ºè®®
    res_3 = "éœ€å…ˆç¡®å®šè®¾è®¡è´¹é¢„ç®—"
    if design_unit_price > 0:
        dup = design_unit_price
        if dup >= 160:
            res_3 = "é€‚åˆæ‰¾é«˜ç«¯è®¾è®¡å¸ˆï¼ˆ10å¹´ä»¥ä¸Šç»éªŒï¼Œç§‘ç­ï¼‰ï¼Œå»ºè®®æ‰¾å½“åœ°æˆ–ç½‘ä¸Šç‹¬ç«‹è®¾è®¡å¸ˆã€‚"
        elif 80 <= dup < 160:
            res_3 = "é€‚åˆæ‰¾é«˜ç«¯è®¾è®¡å¸ˆï¼Œå»ºè®®æ‰¾ç½‘ä¸Šç‹¬ç«‹è®¾è®¡å¸ˆã€å½“åœ°å°å…¬å¸/å·¥ä½œå®¤è€æ¿æˆ–å…¨æ¡ˆå‘˜å·¥ã€‚"
        elif 50 <= dup < 80:
            res_3 = "é€‚åˆæ‰¾é«˜ç«¯è®¾è®¡å¸ˆï¼Œå»ºè®®æ‰¾å½“åœ°å°å…¬å¸/å·¥ä½œå®¤è€æ¿æˆ–è£…ä¿®å…¬å¸è€å‘˜å·¥ï¼ˆéè¥é”€å‹ï¼‰ã€‚"
        elif 30 <= dup < 50:
            res_3 = "å»ºè®®æ‰¾å½“åœ°å°å…¬å¸/å·¥ä½œå®¤è€æ¿æˆ–è£…ä¿®å…¬å¸è€å‘˜å·¥ã€‚"
        else:
             res_3 = "å»ºè®®æ‰¾æ³¨é‡æ€§ä»·æ¯”çš„è£…ä¿®å…¬å¸è®¾è®¡æˆ–è‡ªå­¦è®¾è®¡ã€‚"
    result['designer_level'] = res_3

    # é€»è¾‘å››ï¼šæ–½å·¥æ‰¿åŒ…æ–¹å¼
    res_4 = "å®¢æˆ·æœªæä¾›è¶³å¤Ÿåˆ¤æ–­æ•°æ®ï¼ˆéœ€é¢„ç®—ã€æ€§æ ¼å€¾å‘ï¼‰"
    p_trouble = get_val('personality_trouble') 
    p_cautious = get_val('personality_cautious')
    p_perfect = get_val('personality_perfect')
    weekly_time = get_val('weekly_free_time', 0) or 0 # é˜²æ­¢None
    willing_self = get_val('willing_to_self_build', False)

    if hard_budget and area:
        hup = hard_budget / area
        
        # é«˜é¢„ç®—
        if hup >= 1300:
            if p_trouble == "æ€•éº»çƒ¦":
                res_4 = "å…¨æ¡ˆè½åœ°ã€‚"
            elif p_trouble == "ä¸æ€•éº»çƒ¦":
                res_4 = "å…¨æ¡ˆè½åœ° æˆ– å°å…¨åŒ…ã€‚" # ç®€åŒ–é€»è¾‘
        
        # ä¸­é«˜é¢„ç®—
        elif 900 <= hup < 1300:
            if p_trouble == "æ€•éº»çƒ¦":
                res_4 = "å…¨åŒ… æˆ– å°å…¨åŒ…ã€‚"
            elif p_trouble == "ä¸æ€•éº»çƒ¦" and weekly_time >= 2:
                res_4 = "åŠåŒ… æˆ– å°å…¨åŒ…ã€‚"
            else:
                res_4 = "å»ºè®®å…¨åŒ…ï¼ˆå› æ—¶é—´æˆ–æ€§æ ¼åŸå› ï¼‰ã€‚"

        # ä¸­é¢„ç®—
        elif 500 <= hup < 900:
            if p_trouble == "æ€•éº»çƒ¦" and p_cautious == "è°¨æ…":
                res_4 = "å…¨åŒ… æˆ– å°å…¨åŒ…ã€‚"
            elif p_trouble == "ä¸æ€•éº»çƒ¦" and p_cautious == "è°¨æ…" and weekly_time >= 2:
                res_4 = "åŠåŒ… æˆ– å°å…¨åŒ…ã€‚"
            else:
                 res_4 = "å»ºè®®å…¨åŒ…ã€‚"

        # ä½é¢„ç®—
        elif hup < 500:
            can_self_build = willing_self and weekly_time >= 3
            if can_self_build:
                res_4 = "å¯ä»¥è‡ªè£…ã€‚"
            elif p_cautious == "æ•¢æ”¾æ‰‹" and p_trouble == "æ€•éº»çƒ¦":
                res_4 = "å°å…¨åŒ…ã€‚"
            elif p_cautious == "æ•¢æ”¾æ‰‹" and p_trouble == "ä¸æ€•éº»çƒ¦":
                res_4 = "åŠåŒ…ã€‚"
            else:
                res_4 = "å»ºè®®åŠåŒ…ã€‚"
    
    result['construction_mode'] = res_4

    # é€»è¾‘äº”ï¼šæ–½å·¥æ–¹å»ºè®®
    res_5 = "å®¢æˆ·æœªæä¾›é¢„ç®—æˆ–è¿½æ±‚åå¥½"
    if hard_budget and area and p_perfect:
        hup = hard_budget / area
        if hup >= 900:
            if p_perfect == "è¿½æ±‚å®Œç¾" or p_perfect == "è¿½æ±‚å¹³è¡¡":
                res_5 = "5å¹´ä»¥ä¸Šå…¨æ¡ˆè½åœ°æˆ–ç²¾å·¥æ–½å·¥ã€‚"
            elif p_perfect == "è¿½æ±‚æ€§ä»·æ¯”":
                res_5 = "5å¹´ä»¥ä¸Šä¸­å°å…¬å¸æˆ–å¤§å‹è¿é”ã€‚"
        elif 500 <= hup < 900:
            if p_perfect == "è¿½æ±‚å®Œç¾":
                res_5 = "å¤§å‹å…¨å›½è¿é”ã€‚"
            elif p_perfect == "è¿½æ±‚å¹³è¡¡":
                res_5 = "5å¹´ä»¥ä¸Šä¸­å°è£…ä¿®å…¬å¸ã€‚"
            else:
                 res_5 = "5å¹´ä»¥ä¸Šå°è£…ä¿®å…¬å¸ã€‚"
        else:
             res_5 = "5å¹´ä»¥ä¸Šå°è£…ä¿®å…¬å¸ã€‚"
    result['contractor'] = res_5

    # é€»è¾‘å…­ï¼šè¾…ææ¨è
    res_6 = "æš‚æ— å»ºè®®"
    if hard_budget and area:
        hup = hard_budget / area
        if hup >= 1300:
            res_6 = TEXT_BLOCKS['mat_3']
        elif hup >= 500:
            res_6 = TEXT_BLOCKS['mat_2']
        else:
            res_6 = TEXT_BLOCKS['mat_1']
    result['materials'] = res_6

    # é€»è¾‘ä¸ƒï¼šé›¶å†·æ°´å»ºè®®
    res_7 = "å®¢æˆ·æœªæä¾›é¢ç§¯æ•°æ®"
    if hard_budget and area:
        hup = hard_budget / area
        if hup >= 900: 
            res_7 = "å»ºè®®åšå¤§å¾ªç¯é›¶å†·æ°´ã€‚"
        elif 500 <= hup < 900: 
            if area >= 80:
                res_7 = "å»ºè®®åšå¤§å¾ªç¯ã€‚"
            else:
                res_7 = "å»ºè®®åšå°å¾ªç¯ã€‚"
        else: 
            if area >= 80:
                res_7 = "å»ºè®®åšå°å¾ªç¯ã€‚"
            else:
                res_7 = "å»ºè®®ä¸åšé›¶å†·æ°´ã€‚"
    result['zero_cold_water'] = res_7

    # é€»è¾‘å…«ï¼šæ°´ç”µæ”¹é€ å»ºè®®
    res_8 = "éœ€æä¾›æˆ¿é¾„ä¿¡æ¯"
    is_old = get_val('house_is_old')
    h_age = get_val('house_age', 0) or 0
    
    if is_old and (h_age > 8 or (h_age == 0 and is_old)):
        res_8 = "å…¨æ”¹ã€‚"
    elif not is_old: 
        if hard_budget and area and (hard_budget/area) >= 900:
            res_8 = "æ°´å…¨æ”¹ï¼Œç”µåŠæ”¹æˆ–å…¨æ”¹ã€‚"
        else:
            res_8 = "æ°´ç”µåŠæ”¹ã€‚"
    elif is_old and h_age <= 8:
         if hard_budget and area and (hard_budget/area) < 900:
             res_8 = "æ°´å…¨æ”¹ï¼Œç”µéƒ¨åˆ†åŠæ”¹(å¨å«ç©ºè°ƒå…¨æ”¹)ã€‚"
         else:
             res_8 = "å»ºè®®å…¨æ”¹ï¼ˆé¢„ç®—å……è¶³æƒ…å†µï¼‰ã€‚"
    
    result['plumbing_electric'] = res_8

    # é€»è¾‘ä¹ï¼šè£…ä¿®æ±¡æŸ“
    res_9 = "å»ºè®®æŒç»­å¼€çª—é€šé£"
    vent = get_val('ventilation')
    if hard_budget and area and (hard_budget/area) >= 900:
        res_9 = "å»ºè®®å®‰è£…ä¸­å¤®æ–°é£ã€‚"
    elif vent == "æ™¾æ™’å°äº1å¹´":
         res_9 = "å»ºè®®å£æŒ‚æ–°é£æˆ–æ–°é£æŒ‚æœºã€‚"
    elif vent == "æ™¾æ™’å¤§äº1å¹´" or vent == "å¥½":
         res_9 = "å»ºè®®æŒç»­å¼€çª—é€šé£ï¼Œå¯ä¸è£…æ–°é£ã€‚"
    result['pollution'] = res_9

    # é€»è¾‘åï¼šæµç¨‹å»ºè®®
    res_10 = ""
    accept_design_fee = get_val('budget_can_cover_design', True)
    
    if not accept_design_fee:
        res_10 = TEXT_BLOCKS['flow_3']
    elif score is not None:
        if score >= 5:
            res_10 = TEXT_BLOCKS['flow_1']
        else:
            res_10 = TEXT_BLOCKS['flow_2']
    else:
        res_10 = TEXT_BLOCKS['flow_2'] # é»˜è®¤
    
    result['process'] = res_10
    
    return result

def create_docx(logic_result):
    """ç”ŸæˆWordæ–‡æ¡£"""
    doc = Document()
    
    # æ ·å¼è®¾ç½®
    style = doc.styles['Normal']
    style.font.name = 'å¾®è½¯é›…é»‘'
    style.font.size = Pt(10)
    style.element.rPr.rFonts.set("hint", "å¾®è½¯é›…é»‘")

    # æ ‡é¢˜
    heading = doc.add_heading('æ ¹æ®ä¸ªäººæƒ…å†µç»™å‡ºçš„è£…ä¿®è§„åˆ’æŒ‡å—è¡¨', 0)
    heading.alignment = WD_ALIGN_PARAGRAPH.CENTER
    
    # å†…å®¹
    items = [
        ("**ä¸€ã€é¢„ç®—æ˜¯å¦åˆç†", logic_result['budget_analysis']),
        ("**äºŒã€è®¾è®¡è´¹é¢„ç®—å»ºè®®", logic_result['design_fee']),
        ("**ä¸‰ã€è®¾è®¡å¸ˆæ¡£æ¬¡å»ºè®®", logic_result['designer_level']),
        ("**å››ã€æ–½å·¥æ‰¿åŒ…æ–¹å¼å»ºè®®", logic_result['construction_mode']),
        ("**äº”ã€æ–½å·¥æ–¹å»ºè®®", logic_result['contractor']),
        ("**å…­ã€é€‚åˆçš„è¾…æã€ä¸»ææ¡£æ¬¡", logic_result['materials']),
        ("**ä¸ƒã€é›¶å†·æ°´å»ºè®®ï¼š", logic_result['zero_cold_water']),
        ("**å…«ã€æ°´ç”µå…¨æ”¹åŠæ”¹å»ºè®®ï¼š", logic_result['plumbing_electric']),
        ("**ä¹ã€å…¥ä½æ—¶é—´åŠè£…ä¿®æ±¡æŸ“è§£å†³", logic_result['pollution']),
        ("**åã€æ‰¾è®¾è®¡å¸ˆã€å…¬å¸çš„è¯¦ç»†æµç¨‹å»ºè®®", logic_result['process'])
    ]

    for title, content in items:
        p_title = doc.add_paragraph()
        run_title = p_title.add_run(title)
        run_title.bold = True
        run_title.font.size = Pt(12)
        
        p_content = doc.add_paragraph()
        p_content.add_run("ç­”æ¡ˆå»ºè®®ï¼š\n")
        p_content.add_run(str(content))
        doc.add_paragraph() 

    # ä¿å­˜åˆ°å†…å­˜
    f = io.BytesIO()
    doc.save(f)
    f.seek(0)
    return f

# ================= Streamlit UI =================

st.title("â˜ï¸ è£…ä¿®è§„åˆ’ AI åŠ©æ‰‹ (äº‘ç«¯ä¸“ä¸šç‰ˆ)")
st.markdown("""
**æ”¯æŒæ‰‹æœºæ‹ç…§ä¸Šä¼  | è‡ªåŠ¨åˆ†ææ‰‹å†™/æ‰“å°ä½“ | ç”Ÿæˆ Word æ–¹æ¡ˆ**
*AI å¼•æ“: DeepSeek V3 | OCR å¼•æ“: PaddleOCR (CPU Mode)*
""")

uploaded_file = st.file_uploader("ç‚¹å‡»æ­¤å¤„æ‹ç…§æˆ–é€‰æ‹©æ–‡ä»¶", type=['txt', 'docx', 'doc', 'wps', 'pdf', 'jpg', 'jpeg', 'png'])

if uploaded_file is not None:
    st.info("æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œäº‘ç«¯æ­£åœ¨è¿›è¡Œ OCR è¯†åˆ«ä¸ AI åˆ†æï¼Œè¯·è€å¿ƒç­‰å¾… 10-20 ç§’...")
    
    # 1. æå–æ–‡æœ¬
    text_extraction_success = False
    with st.spinner('ğŸ‘€ æ­£åœ¨è¯†åˆ«å›¾ç‰‡å’Œæ–‡æ¡£ä¸­çš„æ–‡å­—...'):
        raw_text = extract_text_from_file(uploaded_file)
        if raw_text and len(raw_text) > 10:
            text_extraction_success = True
    
    if not text_extraction_success:
        st.error("æœªèƒ½ä»æ–‡ä»¶ä¸­æå–åˆ°æœ‰æ•ˆæ–‡å­—ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡å¤ªæ¨¡ç³Šæˆ–æ ¼å¼ä¸æ”¯æŒã€‚")
    else:
        # 2. AI åˆ†æ
        with st.spinner('ğŸ§  æ­£åœ¨æ€è€ƒå¹¶åˆ¶å®šè§„åˆ’æ–¹æ¡ˆ...'):
            structured_data = analyze_data_with_llm(raw_text)
        
        if structured_data:
            # 3. é€»è¾‘æ¨å¯¼
            logic_result = logic_engine(structured_data)
            
            # 4. å±•ç¤ºé¢„è§ˆ
            st.success("âœ… åˆ†æå®Œæˆï¼")
            
            with st.expander("ç‚¹å‡»æŸ¥çœ‹è§„åˆ’è¯¦æƒ…é¢„è§ˆ"):
                st.write(logic_result)
            
            # 5. ç”Ÿæˆä¸‹è½½
            docx_file = create_docx(logic_result)
            
            st.download_button(
                label="ğŸ“¥ ç‚¹å‡»ä¸‹è½½ã€Šè£…ä¿®è§„åˆ’æŒ‡å—è¡¨ã€‹(Wordæ–‡æ¡£)",
                data=docx_file,
                file_name=f"è£…ä¿®è§„åˆ’æŒ‡å—_{datetime.now().strftime('%Y%m%d_%H%M')}.docx",
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                type="primary"
            )
            
        else:
            st.error("AI æ— æ³•è§£ææ•°æ®ï¼Œè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ–‡ä»¶å†…å®¹æ˜¯å¦å®Œæ•´ã€‚")